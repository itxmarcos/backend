
  proxy_set_header   Host $host;
  proxy_set_header   X-Real-IP $remote_addr;
  proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header   X-Forwarded-Host $server_name;
  proxy_set_header   X-Forwarded-Proto $scheme;
  proxy_set_header   X-Forwarded-Server $host;
  proxy_http_version 1.1;
  proxy_read_timeout 900;

    #https://www.nginx.com/blog/rate-limiting-nginx/

  limit_conn_zone $binary_remote_addr zone=perip:10m;
  limit_conn_zone $server_name zone=perserver:10m;

  limit_req_zone $binary_remote_addr zone=perip2:10m rate=5r/s;

   include /etc/letsencrypt/options-ssl-nginx.conf;
   ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

   server {

      auth_basic              "CSCV Basic Authentication";
      auth_basic_user_file    /etc/nginx/conf.d/registry.password;
      server_name  artemisa.itainnova.es;


    location /health/ {
      default_type text/html;
      return 200 '<!DOCTYPE html><h2>welcome to server Artemisa!</h2>\n';
    }

    location /web/ {
      root  /usr/share/nginx/html/;
      index index.html index.htm;
    }

    location /app/ {
      root  /usr/share/nginx/html/;
      index index.html index.htm;
    }

    location /qgis/ {
      gzip off;
      proxy_pass http://argon-qgis:80;
    }

    location /qgis2/ {
      fastcgi_buffering off;
      gzip off;
      include fastcgi_params;
      fastcgi_param  QGIS_SERVER_LOG_STDERR  1;
      fastcgi_param  QGIS_SERVER_LOG_LEVEL   0;
      fastcgi_pass argon-qgis2:5555;

      add_header Allow "GET, POST, HEAD, OPTIONS" always;
      if ( $request_method !~ ^(GET|POST|HEAD|OPTIONS)$ ) {
        return 405;
      }


    }

    location /api/ {

      add_header Allow "GET, POST, HEAD, OPTIONS" always;
      if ( $request_method !~ ^(GET|POST|HEAD|OPTIONS)$ ) {
        return 405;
      }

      proxy_buffers 16 16k;
      proxy_buffer_size 16k;
      proxy_pass http://argon-rest:3000/;

      limit_conn perip 6;
      limit_conn perserver 100;

      limit_req zone=perip2 burst=12 delay=8;

    }

    location /fenologia/ {
      proxy_buffers 16 16k;
      proxy_buffer_size 16k;
      proxy_pass http://argon-fenologia:8000/fenologia/;
    }

    location /modelos_climaticos/ {
      proxy_buffers 16 16k;
      proxy_buffer_size 16k;
      proxy_pass http://argon-web-modelos:8000/modelos_climaticos/;
    }



    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/artemisa.itainnova.es/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/artemisa.itainnova.es/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

  }


   server {
     # solo para desarrollo
      auth_basic              "CSCV Basic Authentication";
      auth_basic_user_file    /etc/nginx/conf.d/registry.password;
      server_name  artemisa.itainnova.es;


    location /health/ {
      default_type text/html;
      return 200 '<!DOCTYPE html><h2>welcome to server Artemisa!</h2>\n';
    }

    location /api/ {

      proxy_buffers 16 16k;
      proxy_buffer_size 16k;
      proxy_pass http://argon-rest:3000/;

    }

    listen 8443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/artemisa.itainnova.es/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/artemisa.itainnova.es/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


   }

  server {

      listen 80;
      server_name  artemisa.itainnova.es;

      location /.well-known/acme-challenge/ {
        root /var/www/certbot;
	return 200;
      }

      if ($host = artemisa.itainnova.es ) {
          return 301 https://$host$request_uri;
      } # managed by Certbot

      return 404; # managed by Certbot



}
